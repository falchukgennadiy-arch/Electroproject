<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–≠–ª–µ–∫—Ç—Ä–æ–ü—Ä–æ–µ–∫—Ç Donuts - –¢–µ—Å—Ç—ã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-wrapper {
      width: 100%;
      max-width: 480px;
      background: #111;
      padding: 16px;
      padding-bottom: 100px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
    }

    .logo span {
      background: linear-gradient(135deg, #e6c158, #f1c40f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .card {
      background: #1c1c1e;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.04);
    }

    .test-card {
      background: #1c1c1e;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 12px;
      border: 1px solid #2a2a2a;
      cursor: pointer;
      transition: all 0.2s;
    }

    .test-card:hover {
      border-color: #e6c158;
      transform: scale(1.02);
    }

    .test-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .test-description {
      color: #a7a7a7;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .test-meta {
      display: flex;
      gap: 12px;
      color: #666;
      font-size: 13px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.free {
      background: #2ecc71;
      color: #000;
    }

    .badge.test {
      background: #e74c3c;
      color: #fff;
    }

    .question-container {
      margin: 20px 0;
    }

    .question-text {
      font-size: 18px;
      margin-bottom: 20px;
    }

    .answer-btn {
      width: 100%;
      padding: 14px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      text-align: left;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .answer-btn:hover {
      background: #3a3a3a;
    }

    .answer-btn.correct {
      background: rgba(46, 204, 113, 0.3);
      border-color: #2ecc71;
    }

    .answer-btn.wrong {
      background: rgba(231, 76, 60, 0.3);
      border-color: #e74c3c;
    }

    .progress-bar {
      height: 6px;
      background: #2a2a2a;
      border-radius: 999px;
      margin: 16px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #e6c158;
      transition: width 0.3s;
    }

    .explanation {
      background: #2a2a2a;
      border-left: 4px solid #e6c158;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
    }

    .button {
      width: 100%;
      padding: 14px;
      background: #e6c158;
      color: #000;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
    }

    .button.secondary {
      background: transparent;
      border: 1px solid #2a2a2a;
      color: #fff;
    }

    .loader {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .hidden {
      display: none;
    }

    .result-stats {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #3a3a3a;
    }

    .stat-label {
      color: #a7a7a7;
    }

    .stat-value {
      font-weight: 600;
      color: #e6c158;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="header">
      <div class="logo">‚ö° –≠–ª–µ–∫—Ç—Ä–æ–ü—Ä–æ–µ–∫—Ç <span>Donuts</span></div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ -->
    <div id="tests-list" class="section">
      <div class="card">
        <h2 style="margin-bottom: 16px;">üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã</h2>
        <div id="tests-container"></div>
      </div>
    </div>

    <!-- –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ -->
    <div id="test-taking" class="section hidden">
      <div class="card">
        <div id="test-header">
          <h2 id="test-title"></h2>
          <p id="test-description" class="test-description"></p>
        </div>
        
        <div class="progress-bar">
          <div id="progress" class="progress-fill" style="width: 0%"></div>
        </div>
        
        <div id="question-container"></div>
        <div id="explanation-container"></div>
        
        <button id="next-btn" class="button hidden">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
        <button id="back-btn" class="button secondary" onclick="showTestsList()">‚Üê –ö —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</button>
      </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="test-results" class="section hidden">
      <div class="card">
        <h2 style="margin-bottom: 16px;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div id="results-container"></div>
        <button class="button" onclick="showTestsList()">–ö —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</button>
      </div>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const API_URL = 'https://api.omavisual.ru/api';
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    let currentTest = null;
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let testStarted = false;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', loadTests);

    async function loadTests() {
      try {
        const response = await fetch(`${API_URL}/tests`);
        const tests = await response.json();
        renderTestsList(tests);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤:', error);
        document.getElementById('tests-container').innerHTML = `
          <div class="card" style="text-align: center; color: #e74c3c;">
            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.
          </div>
        `;
      }
    }

    function renderTestsList(tests) {
      const container = document.getElementById('tests-container');
      
      if (tests.length === 0) {
        container.innerHTML = `
          <div class="card" style="text-align: center; color: #666;">
            –ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
          </div>
        `;
        return;
      }

      let html = '';
      tests.forEach(test => {
        html += `
          <div class="test-card" onclick="loadTest('${test.id}')">
            <div class="test-title">${test.title}</div>
            <div class="test-description">${test.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            <div class="test-meta">
              <span class="badge ${test.free ? 'free' : 'test'}">
                ${test.free ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞'}
              </span>
              <span>–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${test.passingScore || 70}%</span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    async function loadTest(testId) {
      try {
        const response = await fetch(`${API_URL}/tests/${testId}/full`);
        const testData = await response.json();
        
        currentTest = testData;
        currentQuestions = testData.questions || [];
        currentQuestionIndex = 0;
        userAnswers = new Array(currentQuestions.length).fill(null);
        
        showTestTaking();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç');
      }
    }

    function showTestTaking() {
      document.getElementById('tests-list').classList.add('hidden');
      document.getElementById('test-taking').classList.remove('hidden');
      document.getElementById('test-results').classList.add('hidden');
      
      document.getElementById('test-title').textContent = currentTest.title;
      document.getElementById('test-description').textContent = currentTest.description;
      
      renderQuestion();
    }

    function renderQuestion() {
      const question = currentQuestions[currentQuestionIndex];
      const container = document.getElementById('question-container');
      const explanationContainer = document.getElementById('explanation-container');
      const nextBtn = document.getElementById('next-btn');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
      document.getElementById('progress').style.width = `${progress}%`;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–∞–ª–∏ –ª–∏ —É–∂–µ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
      const answered = userAnswers[currentQuestionIndex] !== null;
      const userAnswer = userAnswers[currentQuestionIndex];
      
      let answersHtml = '';
      question.answers.forEach(answer => {
        let answerClass = 'answer-btn';
        
        if (answered) {
          if (answer.isCorrect) {
            answerClass += ' correct';
          } else if (userAnswer && userAnswer.answerId === answer.id && !answer.isCorrect) {
            answerClass += ' wrong';
          }
        }
        
        answersHtml += `
          <button class="${answerClass}" 
                  onclick="selectAnswer('${answer.id}')"
                  ${answered ? 'disabled' : ''}>
            ${answer.text}
          </button>
        `;
      });
      
      container.innerHTML = `
        <div class="question-text">${question.text}</div>
        ${answersHtml}
      `;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —É–∂–µ –æ—Ç–≤–µ—á–∞–ª–∏
      if (answered) {
        const selectedAnswer = question.answers.find(a => a.id === userAnswer.answerId);
        explanationContainer.innerHTML = `
          <div class="explanation">
            ${question.explanation || '–ù–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏—è'}
          </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ", –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å
        if (currentQuestionIndex < currentQuestions.length - 1) {
          nextBtn.classList.remove('hidden');
          nextBtn.onclick = nextQuestion;
        } else {
          nextBtn.classList.remove('hidden');
          nextBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
          nextBtn.onclick = showResults;
        }
      } else {
        explanationContainer.innerHTML = '';
        nextBtn.classList.add('hidden');
      }
    }

    function selectAnswer(answerId) {
      const question = currentQuestions[currentQuestionIndex];
      const answer = question.answers.find(a => a.id === answerId);
      
      userAnswers[currentQuestionIndex] = {
        questionId: question.id,
        answerId: answerId,
        isCorrect: answer.isCorrect
      };
      
      renderQuestion();
    }

    function nextQuestion() {
      if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      } else {
        showResults();
      }
    }

    function showResults() {
      const correctCount = userAnswers.filter(a => a && a.isCorrect).length;
      const totalQuestions = currentQuestions.length;
      const score = Math.round((correctCount / totalQuestions) * 100);
      const passingScore = currentTest.passingScore || 70;
      const passed = score >= passingScore;
      
      document.getElementById('tests-list').classList.add('hidden');
      document.getElementById('test-taking').classList.add('hidden');
      document.getElementById('test-results').classList.remove('hidden');
      
      let resultsHtml = `
        <div class="result-stats">
          <div class="stat-row">
            <span class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
            <span class="stat-value">${correctCount} –∏–∑ ${totalQuestions}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">–†–µ–∑—É–ª—å—Ç–∞—Ç:</span>
            <span class="stat-value">${score}%</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª:</span>
            <span class="stat-value">${passingScore}%</span>
          </div>
          <div class="stat-row" style="border-bottom: none;">
            <span class="stat-label">–°—Ç–∞—Ç—É—Å:</span>
            <span class="stat-value" style="color: ${passed ? '#2ecc71' : '#e74c3c'}">
              ${passed ? '‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω' : '‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}
            </span>
          </div>
        </div>
      `;
      
      document.getElementById('results-container').innerHTML = resultsHtml;
      
      // TODO: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      // saveTestResults(correctCount, totalQuestions, score);
    }

    function showTestsList() {
      document.getElementById('tests-list').classList.remove('hidden');
      document.getElementById('test-taking').classList.add('hidden');
      document.getElementById('test-results').classList.add('hidden');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
      loadTests();
    }
  </script>
</body>
</html>
